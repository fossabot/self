name: Docstring coverage

on:
  pull_request:
    branches:
      - dev
      - staging
      - main
  push:
    branches:
      - dev
      - staging
      - main

jobs:
  docstring-coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - uses: actions/checkout@v4

      - name: Cache Yarn dependencies
        uses: ./.github/actions/cache-yarn
        with:
          path: |
            .yarn/cache
            node_modules
            */node_modules
            packages/*/node_modules
          cache-version: v1

      - name: Install dependencies
        uses: ./.github/actions/yarn-install

      - name: Generate docstring coverage reports
        run: |
          yarn docstrings:app > /tmp/docstrings-app.log
          yarn docstrings:sdk > /tmp/docstrings-sdk.log
          yarn docstrings:report
          echo "::group::Mobile app coverage (tail)"
          tail -n 25 /tmp/docstrings-app.log || true
          echo "::endgroup::"
          echo "::group::Mobile SDK coverage (tail)"
          tail -n 25 /tmp/docstrings-sdk.log || true
          echo "::endgroup::"

      - name: Upload coverage snapshots
        uses: actions/upload-artifact@v4
        with:
          name: docstring-coverage
          path: |
            docs/coverage/*.json
          if-no-files-found: warn
